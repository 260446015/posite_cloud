<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title class="title" data-href="index">后台管理-用户</title>
    <meta name="renderer" content="webkit"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=0, maximum-scale=0, user-scalable=no">
    <meta name="Author" Content="jianghaifei"/>
    <meta http-equiv="cache-control" content="no-cache">
    <link rel="shortcut icon" href="../img/logozkjl2.png">

    <!--不缓存-->
    <META HTTP-EQUIV="pragma" CONTENT="no-cache">
    <META HTTP-EQUIV="Cache-Control" CONTENT="no-cache, must-revalidate">
    <META HTTP-EQUIV="expires" CONTENT="0">

    <script src="../js/common/jquery-3.3.1.min.js"></script>
    <!--animate-->
    <link rel="stylesheet" href="../css/common/animate.css">
    <!--layui-->
    <link rel="stylesheet" href="../res/layui/css/layui.css">

    <!--自定义-->
    <link rel="stylesheet" href="../css/common/common.css?version=0">
    <link rel="stylesheet" href="../css/common/layout.css?version=0">
    <link rel="stylesheet" href="../css/guanli.css?version=0">
    <style>
        body{
            background: #edeef2;
        }
        .layui-input-block{
            float: left;
            margin: -5px 0 0 0;
        }
        .bz_li {
            float: left;
            min-width: 290px;
            margin-right: 50px;
        }
    </style>
</head>
<body>
<header>
    <img class="logobox" src="../img/logozkjl1.png" alt="">
    <div class="title">
        <p>重点人网络筛查平台</p>
        <p>Key    person    screening</p>
    </div>
    <div class="hd_nav">
        <a href="../index.html">首页</a>
        <a href="importan.html">重点人员</a>
        <a href="jifenyj.html">积分预警</a>
        <!--<a href="report.html">生成报告</a>-->
        <a href="caijishezhi.html">采集设置</a>
        <!--<a>追踪人员</a>-->
        <a class="hd_active" href="houtai_user.html">后台管理</a>
    </div>
    <dl class="hd_dl">
        <dd><span class="usernamecon"></span><img src="../img/defaultimg.png" alt=""></dd>
        <dt class="hd_dt layui-anim layui-anim-upbit">
            <p class="logout">退出登录</p>
            <p>个人中心</p>
        </dt>
    </dl>
</header>
<section>
    <div class="se_title">
        <p><a href="../index.html">HOME</a>   /   后台管理-用户</p>
    </div>

    <div class="section">
        <div class="htbtnbox">
            <a href="houtai_user.html" class="ht_btn ht_active">用户管理</a>
            <!--<a href="houtai_quanxian.html" class="ht_btn">权限管理</a>-->
            <a style="border-right: 1px solid #ccc;" href="houtai_rizhi.html" class="ht_btn">日志管理</a>
        </div>

        <div class="sc_title">用户列表</div>

        <div class="bz_box">
            <div class="bz_li">
                <label>用户名</label>
                <input type="text" class="layui-input bo_username" placeholder="请输入要查询的用户名">
            </div>
            <div class="bz_li">
                <label>姓名</label>
                <input type="text" class="layui-input bo_name" placeholder="请输入要查询的姓名">
            </div>
            <div class="bz_li">
                <label>手机号</label>
                <input type="text" class="layui-input bo_mobile" placeholder="请输入要查询的手机号码">
            </div>
            <!--<div class="bz_li">-->
                <!--<label>注册时间</label>-->
                <!--<input type="text" class="layui-input" id="begin" placeholder="开始时间">-->
                <!--<input type="text" class="layui-input" id="last" placeholder="结束时间" style="margin-left: 10px;">-->
            <!--</div>-->

            <div class="layui-btn layui-btn-normal baocunbtn bc_chaxun">查询</div>
            <div class="layui-btn layui-btn-normal baocunbtn bc_btnadd">添加用户</div>
        </div>

        <div class="bz_tablebox">
            <table cellspacing="0" cellpadding="0" class="bz_table">
                <tr style="" class="bz_firtr">
                    <th>序号</th>
                    <th>姓名</th>
                    <th>用户名</th>
                    <th>年龄</th>
                    <th>手机号</th>
                    <th>邮箱</th>
                    <th>单位部门</th>
                    <th>岗位</th>
                    <th>状态</th>
                    <th>操作</th>
                </tr>
                <tbody class="user_list"></tbody>
            </table>
            <div id='listpage' class='listpage' data-href='["","",""]'></div>
        </div>
    </div>
</section>

<div id="propo_box" class="propo_box layui-form">
    <div class="bz_li">
        <label>用户名</label>
        <input type="text" class="layui-input ba_username" placeholder="请输入用户名">
    </div>
    <div class="bz_li">
        <label>姓名</label>
        <input type="text" class="layui-input ba_name" placeholder="请输入姓名">
    </div>
    <div class="bz_li">
        <label>密码</label>
        <input type="text" class="layui-input ba_passward" placeholder="请输入密码">
    </div>
    <div class="bz_li">
        <label>年龄</label>
        <input type="text" class="layui-input ba_age" placeholder="请输入年龄">
    </div>
    <div class="bz_li">
        <label>手机号</label>
        <input type="text" class="layui-input ba_mobile" placeholder="请输入手机号码">
    </div>
    <div class="bz_li">
        <label>邮箱</label>
        <input type="text" class="layui-input ba_email" placeholder="请输入邮箱">
    </div>
    <div class="bz_li">
        <label>单位部门</label>
        <input type="text" class="layui-input ba_bumen" placeholder="请输入单位部门">
    </div>
    <div class="bz_li">
        <label>岗位</label>
        <input type="text" class="layui-input ba_gangwei" placeholder="请输入岗位">
    </div>
    <div class="bz_li">
        <label>过期时间</label>
        <input type="text" class="layui-input ba_guoqitime" id="timeout" placeholder="请选择过期时间">
    </div>
    <div class="bz_li">
        <label style="margin-bottom: 10px;">是否有权查看积分预警</label>
        <div class="layui-input-block fl">
            <input type="radio" name="sex21" value="group" title="是" checked="">
            <input type="radio" name="sex21" value="normal" title="否">
        </div>
    </div>

    <div class="" style="text-align: center;clear: both;">
        <span class="layui-btn layui-btn-normal baocunbtn pro_queding">确定</span>
        <span class="layui-btn layui-btn-normal baocunbtn pro_quxiao">取消</span>
    </div>
</div>
</body>
<script src="../res/layui/layui.all.js"></script>
<script src="../js/common/common.js?versin=0"></script>
<script>
    layui.use(['laypage', 'form','upload','laydate']);
    var upload = layui.upload;
    var laypage = layui.laypage;
    var laydate = layui.laydate;
    var form = layui.form;
    //常规用法
    laydate.render({
        elem: '#begin'
    });
    laydate.render({
        elem: '#last'
    });
    laydate.render({
        elem: '#timeout'
    });

    //分页
    function setPageNo(count,limitnum) {
        laypage.render({
            elem: 'listpage'
            ,count: count
            ,limit:limitnum
            ,layout: ['count', 'prev', 'page', 'next', 'limit', 'skip']
            ,jump: function(obj,first){
                zdrysc.setpagecss();
                if (!first) {
                    var obdata = JSON.parse($(".listpage").attr("data-href"));
                    getuserlist(obdata[1],(obj.curr - 1),obj.limit,obdata[0],obdata[2]);
                }
            }
        });
    }

    getuserlist("",0,10,"","");
    function getuserlist(name,pageNum,pageSize,username,mobile) {
        $(".user_list").empty();
        $.ajax({
            url: "/api/findUser",
            type: "post",
            xhrFields: {
                withCredentials: true
            },
            data: JSON.stringify({
                name: name,
                pageNum: pageNum,
                pageSize: pageSize,
                username: username,
                mobile:mobile
            }),
            contentType: "application/json",
            success: function (res) {
                console.log(res);
                if (res.code != 0) {
                    return layer.msg(res.message, {anim: 6});
                }
                if (0 === pageNum) {
                    count = res.data.totalNumber;
                    setPageNo(count, pageSize);
                }
                $.each(res.data.dataList,function (i,item) {
                    var aaa
                    if(item.ifEnable){
                        aaa = "已启用"
                    }else{
                        aaa = "已禁用"
                    }
                    if(i%2){
                        list = '<tr class="sc_zdgray">' +
                            '<td>'+(i+1)+'</td>' +
                            '<td>'+item.name+'</td>' +
                            '<td>'+item.username+'</td>' +
                            '<td>'+item.age+'</td>' +
                            '<td>'+item.mobile+'</td>' +
                            '<td>'+item.email+'</td>' +
                            '<td>'+item.department+'</td>' +
                            '<td>'+item.job+'</td>' +
                            '<td><span data-href="'+item.id+'" class="layui-btn layui-btn-normal baocunbtn">'+aaa+'</span></td>' +
                            '<td>' +
                            '    <span data-href="'+item.id+'" class="iconfont icon-bianji"></span>' +
                            '    <span data-href="'+item.id+'" class="iconfont icon-shanchu"></span>' +
                            '</td>' +
                            '</tr>';
                    }else{
                        list = '<tr>' +
                            '<td>'+(i+1)+'</td>' +
                            '<td>'+item.name+'</td>' +
                            '<td>'+item.username+'</td>' +
                            '<td>'+item.age+'</td>' +
                            '<td>'+item.mobile+'</td>' +
                            '<td>'+item.email+'</td>' +
                            '<td>'+item.department+'</td>' +
                            '<td>'+item.job+'</td>' +
                            '<td><span data-href="'+item.id+'" class="layui-btn layui-btn-normal baocunbtn">'+aaa+'</span></td>' +
                            '<td>' +
                            '    <span data-href="'+item.id+'" class="iconfont icon-bianji"></span>' +
                            '    <span data-href="'+item.id+'" class="iconfont icon-shanchu"></span>' +
                            '</td>' +
                            '</tr>';
                    }
                    $(".user_list").append(list);
                });
            }
        })
    }

    //启用与禁用操作
    $(".bz_tablebox").on("click",".baocunbtn",function () {
        var oid = $(this).attr("data-href");
        var ohtml = $(this).html();
        layer.confirm('确定要进行该操作吗？', {
            skin: 'layui-layer-lan', //样式类名
            btn: ['确定','取消'] //按钮
        }, function(){
            setjinyong(oid,ohtml);
        }, function(){
            layer.closeAll()
        });
    });

    //启用禁用方法
    function setjinyong(id,statue) {
        var bbb;
        if(statue=="已启用"){
            bbb = false;
        }else{
            bbb = true;
        }
        $.ajax({
            url: "/api/enable",
            type: "get",
            xhrFields: {
                withCredentials: true
            },
            data: {
                id:id,
                ifEnable:bbb
            },
            success: function (res) {
                //console.log(res);
                if (res.code != 0) {
                    return layer.msg(res.message, {anim: 6});
                }
                layer.closeAll();
                getuserlist("",0,10,"","");
                layer.msg("设置成功");
            }
        });
    }

    //删除
    $(".bz_tablebox").on("click",".icon-shanchu",function () {
        var oid = $(this).attr("data-href");
        layer.confirm('确定要删除该用户吗？', {
            skin: 'layui-layer-lan', //样式类名
            btn: ['确定','取消'] //按钮
        }, function(){
            deletelist(oid);
        }, function(){
            layer.closeAll()
        });
    });

    //删除方法
    function deletelist(oid) {
        $.ajax({
            url: "/api/delete",
            type: "get",
            xhrFields: {
                withCredentials: true
            },
            data: {
                id: oid,
            },
            success: function (res) {
                console.log(res);
                if (res.code != 0) {
                    return layer.msg(res.message, {anim: 6});
                }
                getuserlist("",0,10,"","");
                layer.closeAll();
                layer.msg("删除用户成功");
                $("#propo_box").hide();
            }
        })
    }

    //编辑根据id后去信息
    function getmessage(oid) {
        $.ajax({
            url: "/api/findUserById",
            type: "get",
            xhrFields: {
                withCredentials: true
            },
            data: {
                id:oid,
            },
            success: function (res) {
                //console.log(res);
                if (res.code != 0) {
                    return layer.msg(res.message, {anim: 6});
                }
                var ores = res.data;
                $(".ba_bumen").val(ores.department);
                $(".ba_email").val(ores.email);
                $(".ba_guoqitime").val(ores.expireTime);
                $(".ba_gangwei").val(ores.job);
                $("input[name='sex21']").attr('checked', true);
                $(".ba_name").val(ores.name);
                $(".ba_passward").val(ores.password);
                $(".ba_username").val(ores.username);
                $(".ba_mobile").val(ores.mobile);
                $(".ba_age").val(ores.age);
                $(".pro_queding").attr("data-id",ores.id);
                $(".ba_age").attr("data-bollean",ores.ifEnable);
                form.render();
            }
        });
    }

    //编辑
    $(".bz_tablebox").on("click",".icon-bianji",function () {
        getmessage($(this).attr("data-href"));
        $(".pro_queding").attr("data-href","1");
        layer.open({
            title: '新增用户',
            area: ['760px', '390px'],
            type: 1,
            skin: 'layui-layer-lan', //样式类名
            closeBtn: 1, //不显示关闭按钮
            anim: 1,
            content: $('#propo_box'),
            cancel: function () {
                $("#propo_box").hide();
            }
        });
    });

    //添加用户事件
    $(".bc_btnadd").click(function () {
        $(".propo_box").find(".layui-input").each(function (i,item) {
            item.value = "";
        });
        $(".pro_queding").attr("data-href","2");
        layer.open({
            title: '新增用户',
            area: ['760px', '390px'],
            type: 1,
            skin: 'layui-layer-lan', //样式类名
            closeBtn: 1, //不显示关闭按钮
            anim: 1,
            content: $('#propo_box'),
            cancel: function () {
                $("#propo_box").hide();
            }
        });
    });

    //添加用户方法
    function adduser() {
        $.ajax({
            url: "/api/create",
            type: "post",
            xhrFields: {
                withCredentials: true
            },
            data: JSON.stringify({
                department: $(".ba_bumen").val(),
                email: $(".ba_email").val(),
                expireTime: $(".ba_guoqitime").val(),
                job: $(".ba_gangwei").val(),
                jobLevel: $("input[name='sex21']:checked").val(),
                name: $(".ba_name").val(),
                password: $(".ba_passward").val(),
                username: $(".ba_username").val(),
                mobile:$(".ba_mobile").val(),
                age:$(".ba_age").val(),
                ifEnable:true
            }),
            contentType: "application/json",
            success: function (res) {
                console.log(res);
                if (res.code != 0) {
                    return layer.msg(res.message, {anim: 6});
                }
                getuserlist("",0,10,"","");
                layer.closeAll();
                layer.msg("添加用户成功");
                $("#propo_box").hide();
            }
        })
    }

    //编辑提交用户方法
    function saveeditadduser() {
        $.ajax({
            url: "/api/create",
            type: "post",
            xhrFields: {
                withCredentials: true
            },
            data: JSON.stringify({
                id:$(".pro_queding").attr("data-id"),
                department: $(".ba_bumen").val(),
                email: $(".ba_email").val(),
                expireTime: $(".ba_guoqitime").val(),
                job: $(".ba_gangwei").val(),
                jobLevel: $("input[name='sex21']:checked").val(),
                name: $(".ba_name").val(),
                password: $(".ba_passward").val(),
                username: $(".ba_username").val(),
                mobile:$(".ba_mobile").val(),
                age:$(".ba_age").val(),
                ifEnable:$(".ba_age").attr("data-bollean")
            }),
            contentType: "application/json",
            success: function (res) {
                console.log(res);
                if (res.code != 0) {
                    return layer.msg(res.message, {anim: 6});
                }
                getuserlist("",0,10,"","");
                layer.closeAll();
                layer.msg("编辑用户成功");
                $("#propo_box").hide();
            }
        })
    }

    $(".pro_quxiao").click(function () {
       layer.closeAll();
        $("#propo_box").hide();
    });

    $(".pro_queding").click(function () {
        var list = 0;
        $(".propo_box").find(".layui-input").each(function (i,item) {
            if(!item.value){
                $(this).css("border-color","red");
                list++;
            }else{
                $(this).css("border-color","#e6e6e6")
            }
        });
        if(list>0){
            return layer.msg("请补全信息", {anim: 6});
        }
        var _index = $(this).attr("data-href");
        if(_index=="1"){//edit
            saveeditadduser();
        }else if(_index=="2"){//add
            adduser();
        }
    });

    //查询
    $(".bc_chaxun").click(function () {
        var list = [$(".bo_username").val(),$(".bo_name").val(),$(".bo_mobile").val()];
        $(".listpage").attr("data-href",JSON.stringify(list));
        getuserlist($(".bo_name").val(),0,10,$(".bo_username").val(),$(".bo_mobile").val());
    });
</script>
</html>